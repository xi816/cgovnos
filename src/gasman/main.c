#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <unistd.h>
#include <stdbool.h>
#include <termios.h>

#include "../main.h"
#include "../../lib/namings.h"

#define MAXPAGES 256
#define PAGESIZE 256
#define LINESIZE 16

// Page 0 instructions (aligned to 5 bytes)
I8* GC_TABLE[][256] = {{
  "NOP  ", "CPUID", "CSP  ", "SHL  ", "SHR  ", "MOD  ", "CALL ", "JMP  ", "JMI  ", "RET  ", "CALI ", "...  ", "...  ", "...  ", "...  ", "...  ",
  "RDDW ", "CMP  ", "CMIM ", "AND  ", "OR   ", "XOR  ", "NAND ", "NOR  ", "NOT  ", "PUSH ", "POP  ", "DUP  ", "SWAP ", "ADD  ", "SUB  ", "MUL  ",
  "RDDB ", "REAB ", "REAW ", "INT  ", "DIV  ", "RDDWR", "INC  ", "DEC  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ",
  "...  ", "...  ", "...  ", "...  ", "...  ", "LODB ", "LODW ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ",
  "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "LSP  ", "LCS  ", "SSP  ", "SCS  ", "SPC  ", "...  ",
  "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ",
  "...  ", "...  ", "...  ", "INA  ", "INB  ", "IIC  ", "IND  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ",
  "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ",
  "...  ", "...  ", "...  ", "DEA  ", "DEB  ", "DDC  ", "DED  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ",
  "ADI  ", "SUI  ", "MUI  ", "DII  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ",
  "LDA  ", "LDB  ", "LDC  ", "LDD  ", "LSR  ", "...  ", "...  ", "...  ", "...  ", "$SPC ", "$GFS ", "...  ", "...  ", "...  ", "...  ", "...  ",
  "ADA  ", "ADB  ", "ADC  ", "AAD  ", "PSR  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ",
  "SUA  ", "SSB  ", "SUC  ", "SUD  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ",
  "MUA  ", "MUB  ", "MUC  ", "MUD  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ",
  "DIA  ", "DIB  ", "DIC  ", "DID  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ",
  "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  "},
  {
  "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ",
  "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ",
  "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ",
  "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ",
  "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ",
  "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ",
  "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ",
  "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ",
  "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ",
  "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ",
  "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ",
  "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ",
  "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ",
  "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ",
  "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ",
  "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  "}
};

U0 render(U8 page, U8 ind) {
  printf("\033[HGASMAN 1.0 | PAGE %02X (%d) | INDEX %02X (%03d)\n", page, page, ind, ind);
  printf("     ");
  for (I16 i = 0; i < LINESIZE; i++) {
    printf("%02X    ", i);
  }
  for (I16 i = 0; i < PAGESIZE; i++) {
    if (i % LINESIZE == 0) {
      printf("\n%02X | ", i);
    }
    if (i == ind) {
      printf("\033[47m\033[30m%s\033[0m ", GC_TABLE[page][i]);
    }
    else {
      printf("%s ", GC_TABLE[page][i]);
    }
  }
  puts("\0");
}

U0 renderInfo() {
  printf("\033[20;25H |---------------------|");
  printf("\033[21;25H |ZERO PAGE IS WRITTEN |");
  printf("\033[22;25H |BY ITS VALUE. OTHERS |");
  printf("\033[23;25H |ARE WRITTEN AS %%0BA  |");
  printf("\033[24;25H |%%PAGE %%INST          |");
  printf("\033[25;25H |---------------------|");
}

U0 hexToDec() {
  U8 numbuf[19];
  for (I16 i = 0; i < 19; i++)
    numbuf[i] = 0;
  U8 numbufi = 0;
  U8 hk = 0;
  while (hk != 10) {
    printf("\033[20;25H |---------------------|");
    printf("\033[21;25H |ENTER VALUE          |");
    printf("\033[22;25H |: %s", numbuf);
    printf("\033[22;47H |");
    printf("\033[23;25H |ANSWER:              |");
    printf("\033[24;25H |---------------------|");
    hk = getchar();
    if ((hk >= 48) && (hk <= 57)) {
      numbuf[numbufi] = hk;
      // numbuf[numbufi+1] = 0;
      numbufi++;
    }
  }
  I32 n = atoi(numbuf);
  printf("\033[20;25H |---------------------|");
  printf("\033[21;25H |ENTER VALUE          |");
  printf("\033[22;25H |: %s", numbuf);
  printf("\033[22;47H |");
  printf("\033[23;25H |ANSWER: %X", n);
  printf("\033[23;47H |");
  printf("\033[24;25H |---------------------|");
}

I32 main(I32 argc, I8** argv) {
  new_st;
  printf("\033[H\033[2J");
  U8 k = 32;
  U8 page = 0;
  U8 ind = 0;
  render(page, ind);
  while (true) {
    k = getchar();
    if (k == 'q') break;
    else if (k == 'i') {
      renderInfo();
      getchar();
      printf("\033[H\033[2J");
    }
    else if (k == 'h') {
      hexToDec();
      getchar();
      printf("\033[H\033[2J");
    }
    else if (k == 27) {
      getchar();
      switch (getchar()) {
        case 'A':
          ind -= 16;
          break;
        case 'B':
          ind += 16;
          break;
        case 'C':
          ind++;
          break;
        case 'D':
          ind--;
          break;
      }
    }
    else if (k == '=') {
      page++;
    }
    else if (k == '-') {
      page--;
    }
    render(page, ind);
  }
  old_st;
  puts("\0");
  return 0;
}
